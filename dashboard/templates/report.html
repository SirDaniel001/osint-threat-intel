<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Financial Threat Intel Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <style>
    @page { size: A4; margin: 14mm; }
    h1,h2,h3 { margin: 0 0 .5rem 0; }
    .kpi { border: 1px solid #eee; border-radius: 8px; padding: 12px; background:#fafafa; }
    .page-break { page-break-before: always; }
    .small { font-size: .9rem; color: #555; }
    .muted { color: #777; }
    table { font-size: 0.95rem; }
    header img { max-height: 60px; margin-right: 15px; }
  </style>
</head>
<body>
<div class="container">
  <header class="mb-4 d-flex align-items-center">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
    <div>
      <h1>Financial Threat Intelligence Report</h1>
      <div class="small muted">
        Generated: {{ meta.generated_at }} | Period: {{ meta.period }}
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="mb-4">
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="kpi">
          <div class="muted">Phishing Domains</div>
          <div class="fs-3 fw-bold">{{ kpis.phishing_count }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi">
          <div class="muted">Dark Web Hits</div>
          <div class="fs-3 fw-bold">{{ kpis.darkweb_hits }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi">
          <div class="muted">WHOIS Flags</div>
          <div class="fs-3 fw-bold">{{ kpis.whois_suspicious }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi">
          <div class="muted">Alerts Sent</div>
          <div class="fs-3 fw-bold">{{ kpis.alerts }}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Trend Chart -->
  <section class="mb-4">
    <h2>Phishing Activity (Last 14 Days)</h2>
    <canvas id="trendChart" height="120"></canvas>
  </section>

  <!-- Recent Findings -->
  <section class="mb-4 page-break">
    <h2>Recent High-Signal Findings</h2>
    <table class="table table-sm table-striped">
      <thead><tr><th>#</th><th>Indicator</th><th>Source</th><th>Detected</th></tr></thead>
      <tbody>
      {% if recent %}
        {% for r in recent %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r['domain'] if 'domain' in r.keys() else (r['ioc'] if 'ioc' in r.keys() else '') }}</td>
            <td>{{ r['source'] if 'source' in r.keys() else '' }}</td>
            <td>{{ r['date_found'] if 'date_found' in r.keys() else (r['created_at'] if 'created_at' in r.keys() else '') }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="4" class="text-muted">No recent records available.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </section>

  <!-- Notes -->
  <section class="mb-4">
    <h2>Notes</h2>
    <ul>
      <li>Sources include surface web scrapers, dark web crawlers, and WHOIS checks.</li>
      <li>Indicators are unverified leadsâ€”use in triage workflows before blocking.</li>
      <li>Time is UTC. Data is for defensive security use on authorized systems.</li>
    </ul>
  </section>
</div>

<script>
(function(){
  const labels = {{ labels|tojson }};
  const values = {{ values|tojson }};
  const ctx = document.getElementById('trendChart').getContext('2d');
  const data = values && values.length ? values : [0];
  const labs = labels && labels.length ? labels : ['N/A'];

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labs,
      datasets: [{
        label: 'Domains / day',
        data: data,
        tension: 0.25,
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13,110,253,.2)',
        fill: true,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const date = labs[index];
          if (date) {
            window.location.href = `/threats?date_from=${date}&date_to=${date}`;
          }
        }
      }
    }
  });

  setTimeout(()=>{ window.__REPORT_READY__ = true; }, 1200);
})();
</script>
</body>
</html>
